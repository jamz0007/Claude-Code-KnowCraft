---
argument-hint: <item-id> [--force] [--archive]
description: 删除知识条目(自动清理链接)
allowed-tools: Read, Write, Edit, Bash
---

# /kb-delete - 删除知识条目

## 功能
删除知识条目,自动清理相关链接和索引,支持归档模式避免误删。

## 使用方式

### 基本用法(交互式确认)
```
/kb-delete 2025-01-04-143052

⚠️  警告: 即将删除条目 "React Hooks 深入理解"
ID: 2025-01-04-143052
链接: 2 个
反向链接: 1 个

这将:
1. 删除知识文件
2. 从索引中移除
3. 清理所有关联的链接和反向链接

确认删除? (yes/no):
```

### 强制删除(跳过确认)
```
/kb-delete 2025-01-04-143052 --force

✅ 条目已删除!
```

### 归档模式(移动到回收站)
```
/kb-delete 2025-01-04-143052 --archive

✅ 条目已归档到 knowledge/.trash/
```

## 参数说明
- `item-id`: 知识条目 ID (必需)
- `--force`: 强制删除,跳过确认提示
- `--archive`: 归档到 `.trash/` 目录而不是永久删除

## 工作流程

### 1. 验证条目存在
```
检查 item-id 是否存在于 index.json
```

### 2. 检查依赖关系
```
查找所有引用此条目的链接:
- 反向链接 (backlinks)
- 其他条目的 links 字段
```

### 3. 确认删除(除非使用 --force)
```
显示条目信息和依赖关系
等待用户确认
```

### 4. 清理链接
```
对于每个反向链接:
1. 打开引用该条目的文件
2. 从 links 数组中移除链接
3. 保存文件
```

### 5. 更新关系图谱
```
从 relationships.json 中移除:
- 所有相关的边
- 相关的节点数据
```

### 6. 删除或归档文件

**普通删除模式**:
```
删除 knowledge/items/YYYY/MM-Month/item-id.md
```

**归档模式** (--archive):
```
移动到 knowledge/.trash/YYYY-MM/item-id.md
保留元数据和完整内容
```

### 7. 更新索引
```
从 index.json 的 items 数组中移除
更新统计信息:
- totalItems -1
- 更新分类计数
- 更新标签计数
- totalLinks -= 该条目的链接数
```

### 8. 清理版本历史
```
删除 knowledge/.versions/ 中所有相关版本:
2025-01-04-143052.v1.md
2025-01-04-143052.v2.md
...
```

## 归档系统

### 归档目录结构
```
knowledge/.trash/
├── 2025-01/
│   ├── 2025-01-04-143052.md
│   └── .metadata/
│       └── 2025-01-04-143052.json
└── index.json
```

### 归档元数据
```json
{
  "id": "2025-01-04-143052",
  "title": "React Hooks 深入理解",
  "deletedAt": "2025-01-04T17:30:00Z",
  "deletedBy": "user",
  "reason": "duplicate content",
  "originalPath": "/knowledge/items/2025/01-January/2025-01-04-143052.md",
  "links": 2,
  "backlinks": 1
}
```

### 恢复归档条目
```
/kb-restore 2025-01-04-143052 --from-trash

✅ 条目已从回收站恢复!
```

## 示例

### 删除前确认
```
/kb-delete 2025-01-04-143052

⚠️  即将删除条目

标题: React Hooks 深入理解
ID: 2025-01-04-143052
创建: 2025-01-04 14:30
修改: 2025-01-04 16:45
版本: 5

依赖关系:
  链接: 2 个
  → references: 2025-01-03-102015 (React 基础概念)
  → builds-on: 2025-01-02-084530 (函数组件)

  反向链接: 1 个
  ← from: 2025-01-05-091234 (自定义 Hook)

删除影响:
  • 2025-01-05-091234 的一个链接将失效

确认删除? (yes/no): yes

✅ 条目已删除!
文件: knowledge/items/2025/01-January/2025-01-04-143052.md
版本备份: 已清理 5 个版本文件
链接: 已清理 3 个关联
索引: 已更新
```

### 强制删除
```
/kb-delete 2025-01-04-143052 --force

✅ 条目已删除!
ID: 2025-01-04-143052
标题: React Hooks 深入理解
清理的链接: 3 个
```

### 归档模式
```
/kb-delete 2025-01-04-143052 --archive

✅ 条目已归档!
归档位置: knowledge/.trash/2025-01/2025-01-04-143052.md
元数据: knowledge/.trash/.metadata/2025-01-04-143052.json

如需恢复: /kb-restore 2025-01-04-143052 --from-trash
```

### 查看回收站
```
/kb-delete --list-trash

回收站中的条目 (3 个):

1. 2025-01-04-143052 - React Hooks 深入理解
   删除: 2025-01-04 17:30
   原因: duplicate content

2. 2025-01-03-102015 - JavaScript 异步编程
   删除: 2025-01-03 16:20
   原因: outdated

3. 2025-01-02-084530 - 函数组件
   删除: 2025-01-02 14:10
   原因: merged into newer version
```

### 清空回收站
```
/kb-delete --empty-trash

⚠️  即将永久删除回收站中的 3 个条目
此操作不可撤销!

确认清空? (yes/no): yes

✅ 回收站已清空!
删除的文件: 3
释放的空间: 45 KB
```

## 链接清理

### 自动清理过程

1. **查找反向链接**:
```bash
从 index.json 查找所有 links 中包含 target-id 的条目
```

2. **移除前向链接**:
```yaml
# 引用该条目的文件
links:
  - to: 2025-01-04-143052  # ← 删除这一行
    type: references
```

3. **验证清理**:
```bash
确认所有相关文件已更新
```

### relationships.json 更新
```json
// 删除前
{
  "nodes": [
    { "id": "2025-01-04-143052", "label": "React Hooks" },
    { "id": "2025-01-03-102015", "label": "React Basics" }
  ],
  "edges": [
    { "from": "2025-01-04-143052", "to": "2025-01-03-102015", "type": "references" }
  ]
}

// 删除后
{
  "nodes": [
    { "id": "2025-01-03-102015", "label": "React Basics" }
  ],
  "edges": []
}
```

## 批量删除

### 按标签批量删除
```
/kb-delete --batch --tag=outdated

找到 5 个标签为 "outdated" 的条目:
1. 2025-01-01-100000 - 旧版 React 文档
2. 2025-01-02-110000 - 过时的 API 参考
...

确认批量删除? (yes/no): yes

✅ 已删除 5 个条目!
```

### 按分类批量删除
```
/kb-delete --batch --category=personal --archive

找到 3 个 personal 分类的条目
将归档到回收站

确认批量归档? (yes/no): yes

✅ 已归档 3 个条目!
```

### 按日期范围删除
```
/kb-delete --batch --before=2024-01-01

找到 12 个 2024 年之前的条目

确认批量删除? (yes/no): yes

✅ 已删除 12 个条目!
```

## 错误处理

### 条目不存在
```
❌ 错误: 条目 2025-01-99-999999 不存在
请使用 /kb-list 查看所有条目
```

### 权限错误
```
❌ 错误: 无法删除文件
检查文件权限: knowledge/items/2025/01-January/2025-01-04-143052.md
```

### 索引更新失败
```
⚠️  警告: 文件已删除,但索引更新失败
请手动运行 /kb-reindex 重建索引
```

### 回收站已满
```
⚠️  警告: 回收站已满(超过 100 MB)
请先清空回收站: /kb-delete --empty-trash
```

## 安全建议

### 删除前检查清单
- [ ] 确认条目确实不再需要
- [ ] 检查是否有其他条目依赖它
- [ ] 考虑是否应该归档而不是删除
- [ ] 备份重要内容到其他地方

### 使用归档模式
```
对于不确定是否要永久删除的内容,始终使用 --archive:
/kb-delete 2025-01-04-143052 --archive
```

### 定期清理回收站
```
建议每月检查并清理回收站:
/kb-delete --list-trash
/kb-delete --empty-trash
```

### 恢复误删条目
```
如果使用了归档模式,可以恢复:
/kb-restore 2025-01-04-143052 --from-trash

如果永久删除,可以尝试从系统回收站恢复
或在 .versions/ 目录查找旧版本
```

## 注意事项

### 不可逆操作
- 永久删除不可恢复(除非有系统备份)
- 建议先使用归档模式
- 定期备份整个知识库

### 链接断裂
- 删除操作会自动清理链接
- 但不会更新内容中的引用
- 建议删除前检查内容中的文本引用

### 性能考虑
- 批量删除大量条目可能需要较长时间
- 删除过程中不要中断
- 确保有足够的磁盘空间

### 最佳实践
1. **先归档,后删除**: 使用 --archive 测试
2. **定期清理回收站**: 每月清空一次
3. **批量删除前预览**: 使用 /kb-list 验证
4. **保留重要版本**: 使用版本控制而非删除

## 统计信息

### 查看删除统计
```
/kb-delete --stats

删除统计:
  总删除: 15 个条目
  回收站: 5 个条目
  永久删除: 10 个条目
  本月删除: 3 个条目
  回收站大小: 125 KB
```

## 扩展功能(未来)

### 撤销删除
```
/kb-delete --undo
撤销最近的删除操作(如果还在回收站)
```

### 定时清理
```
/kb-delete --schedule="weekly"
自动删除回收站中超过 30 天的条目
```

### 删除原因分析
```
/kb-delete --analyze
分析删除模式,帮助优化知识管理
```
